<!DOCTYPE html>
<html lang="ko">
<head>
    <script type="module" src="auth-check.js"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI ì´ë¯¸ì§€ ìŠ¤íƒ€ì¼ ê´€ë¦¬</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: white;
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 30px;
            text-align: center;
        }

        .header h1 {
            color: #667eea;
            margin-bottom: 10px;
        }

        .back-link {
            display: inline-block;
            margin-top: 15px;
            padding: 10px 20px;
            background: white;
            border: 2px solid #667eea;
            color: #667eea;
            text-decoration: none;
            border-radius: 10px;
            font-weight: 600;
            transition: all 0.3s;
        }

        .back-link:hover {
            background: #667eea;
            color: white;
        }

        .main-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .section {
            background: white;
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .section h2 {
            color: #333;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 3px solid #667eea;
        }

        .drop-zone {
            border: 3px dashed #e0e0e0;
            border-radius: 12px;
            padding: 40px 20px;
            background: #fafafa;
            cursor: pointer;
            transition: all 0.3s;
            min-height: 200px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            margin-bottom: 20px;
        }

        .drop-zone:hover {
            border-color: #667eea;
            background: #f0f4ff;
        }

        .drop-zone.dragover {
            border-color: #667eea;
            background: #e0e7ff;
            transform: scale(1.02);
        }

        .drop-zone.has-image {
            padding: 0;
            border: 2px solid #667eea;
            background: white;
        }

        .preview-image {
            max-width: 100%;
            max-height: 300px;
            border-radius: 10px;
        }

        .drop-icon {
            font-size: 3em;
            margin-bottom: 10px;
            color: #999;
        }

        .drop-text {
            color: #666;
            font-size: 1em;
            margin-bottom: 5px;
        }

        .drop-hint {
            color: #999;
            font-size: 0.85em;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }

        input[type="text"] {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            margin-bottom: 15px;
        }

        select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            margin-bottom: 15px;
            background: white;
        }

        textarea {
            width: 100%;
            min-height: 200px;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-family: monospace;
            font-size: 13px;
            resize: vertical;
            margin-bottom: 15px;
            white-space: pre-wrap;
            line-height: 1.6;
        }

        button {
            padding: 15px 30px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            width: 100%;
            margin-bottom: 10px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #667eea;
            font-size: 18px;
        }

        .spinner {
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error {
            background: #fee;
            color: #c33;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .success {
            background: #e7f9e7;
            color: #2d7d2d;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .info {
            background: #e7f3ff;
            color: #0066cc;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 0.9em;
        }

        .styles-list {
            margin-top: 20px;
        }

        .style-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            transition: all 0.2s;
            border: 2px solid transparent;
        }

        .style-item:hover {
            background: #e9ecef;
        }

        .style-item-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 10px;
        }

        .style-item h4 {
            color: #333;
            margin-bottom: 5px;
        }

        .style-item-actions {
            display: flex;
            gap: 5px;
        }

        .style-item-actions button {
            padding: 5px 10px;
            font-size: 12px;
            border-radius: 4px;
            width: auto;
        }

        .btn-edit {
            background: #3B82F6;
            color: white;
        }

        .btn-delete {
            background: #EF4444;
            color: white;
        }

        .style-item p {
            color: #666;
            font-size: 0.9em;
            margin-bottom: 5px;
        }

        .style-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.75em;
            font-weight: 600;
            margin-left: 8px;
        }

        .badge-face-only {
            background: #dbeafe;
            color: #1e40af;
        }

        .badge-face-clothing {
            background: #fce7f3;
            color: #9f1239;
        }

        input[type="file"] {
            display: none;
        }

        @media (max-width: 1024px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ¨ AI ì´ë¯¸ì§€ ìŠ¤íƒ€ì¼ ê´€ë¦¬</h1>
            <p>Gemini 2.5 Proë¡œ ìŠ¤íƒ€ì¼ ë¶„ì„ ë° ê´€ë¦¬</p>
            <a href="index.html" class="back-link">â† ëŒ€ì‹œë³´ë“œë¡œ ëŒì•„ê°€ê¸°</a>
        </div>

        <div class="main-grid">
            <!-- ì™¼ìª½: ìŠ¤íƒ€ì¼ ìƒì„± -->
            <div class="section">
                <h2>ğŸ“ ìŠ¤íƒ€ì¼ ìƒì„±/ìˆ˜ì •</h2>

                <div class="info">
                    ğŸ’¡ ë ˆí¼ëŸ°ìŠ¤ ì´ë¯¸ì§€ ì—…ë¡œë“œëŠ” ì„ íƒì‚¬í•­ì…ë‹ˆë‹¤<br>
                    ğŸ’¡ ì´ë¯¸ì§€ë¥¼ ë¶„ì„í•˜ë©´ 150ì ì´ë‚´ì˜ ì§§ì€ ì°¸ê³  ì •ë³´ë¥¼ ì œê³µí•©ë‹ˆë‹¤<br>
                    ğŸ’¡ <strong>ìŠ¤íƒ€ì¼ í”„ë¡¬í”„íŠ¸ëŠ” ë°˜ë“œì‹œ ì§ì ‘ ì‘ì„±í•´ì•¼ í•©ë‹ˆë‹¤</strong>
                </div>

                <label>ìŠ¤íƒ€ì¼ ID *</label>
                <input type="text" id="styleId" placeholder="ì˜ˆ: medieval, clay-art, ghibli">

                <label>ìŠ¤íƒ€ì¼ ì´ë¦„ *</label>
                <input type="text" id="styleName" placeholder="ì˜ˆ: ì¤‘ì„¸ ìŠ¤íƒ€ì¼, í´ë ˆì´ì•„íŠ¸">

                <label>ìŠ¤íƒ€ì¼ íƒ€ì… *</label>
                <select id="styleType">
                    <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                    <option value="face_only">ì–¼êµ´ë§Œ ìœ ì§€ (ì˜·/ë°°ê²½ ë³€ê²½)</option>
                    <option value="face_and_clothing">ì–¼êµ´+ì˜· ìœ ì§€ (ì¬ì§ˆ/ì§ˆê°ë§Œ ë³€ê²½)</option>
                </select>

                <div class="info" style="font-size: 0.85em;">
                    â„¹ï¸ <strong>ì–¼êµ´ë§Œ ìœ ì§€:</strong> ì¤‘ì„¸, ë¯¸ë˜ ë“± ì¸ë¬¼ì˜ ì˜·ê³¼ ë°°ê²½ì´ ë°”ë€ŒëŠ” ìŠ¤íƒ€ì¼<br>
                    â„¹ï¸ <strong>ì–¼êµ´+ì˜· ìœ ì§€:</strong> í´ë ˆì´ì•„íŠ¸, ìˆ˜ì±„í™” ë“± ì¬ì§ˆë§Œ ë³€í™˜í•˜ëŠ” ìŠ¤íƒ€ì¼
                </div>

                <label>ê³µê°œ ì„¤ì • *</label>
                <select id="isPublic">
                    <option value="true">âœ… ê³µê°œ (ì‚¬ìš©ìì—ê²Œ í‘œì‹œ)</option>
                    <option value="false">ğŸ”’ ë¹„ê³µê°œ (ê°œë°œ ì¤‘, ì‚¬ìš©ìì—ê²Œ ìˆ¨ê¹€)</option>
                </select>

                <div class="info" style="font-size: 0.85em; margin-bottom: 15px;">
                    â„¹ï¸ ë¹„ê³µê°œë¡œ ì„¤ì •í•˜ë©´ ì‚¬ìš©ì í˜ì´ì§€ì— í‘œì‹œë˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ê°œë°œ/í…ŒìŠ¤íŠ¸ í›„ ê³µê°œë¡œ ì „í™˜í•˜ì„¸ìš”.
                </div>

                <label>ë ˆí¼ëŸ°ìŠ¤ ì´ë¯¸ì§€ (ì„ íƒì‚¬í•­)</label>
                <input type="file" id="referenceImageInput" accept="image/*">
                <div id="referenceDropZone" class="drop-zone">
                    <div class="drop-icon">ğŸ¨</div>
                    <div class="drop-text">ë ˆí¼ëŸ°ìŠ¤ ì´ë¯¸ì§€ ì—…ë¡œë“œ (ì„ íƒ)</div>
                    <div class="drop-hint">í´ë¦­í•˜ê±°ë‚˜ ë“œë˜ê·¸ ì•¤ ë“œë¡­</div>
                </div>

                <button class="btn-secondary" onclick="analyzeImage()" id="analyzeBtn">ğŸ” ì´ë¯¸ì§€ ìŠ¤íƒ€ì¼ ë¶„ì„ (ì°¸ê³ ìš©)</button>

                <div id="analysisReference" style="display: none; background: #F3F4F6; border-left: 4px solid #6B7280; padding: 12px; border-radius: 4px; margin-bottom: 15px;">
                    <strong style="color: #374151;">ğŸ“Š ë¶„ì„ ê²°ê³¼ (ì°¸ê³ ìš©):</strong>
                    <p id="analysisText" style="margin: 8px 0 0 0; color: #6B7280; font-size: 14px;"></p>
                </div>

                <label>ìŠ¤íƒ€ì¼ í”„ë¡¬í”„íŠ¸ * (ì§ì ‘ ì‘ì„± í•„ìˆ˜)</label>
                <div class="info" style="margin-bottom: 10px;">
                    ğŸ’¡ Gemini 2.5 Flash Imageê°€ ì‚¬ìš©í•  í”„ë¡¬í”„íŠ¸ë¥¼ ì§ì ‘ ì‘ì„±í•˜ì„¸ìš”<br>
                    ğŸ’¡ ìœ„ ë¶„ì„ ê²°ê³¼ëŠ” ì°¸ê³ ìš©ì´ë©°, ì—¬ê¸°ì— ìƒì„¸í•œ í”„ë¡¬í”„íŠ¸ë¥¼ ì‘ì„±í•´ì•¼ í•©ë‹ˆë‹¤
                </div>
                <textarea id="stylePrompt" placeholder="ì˜ˆ: A vibrant anime style with bold outlines and bright colors. The character should have large expressive eyes typical of anime art. Background should be simple with pastel tones. Include soft shadows and cell-shading technique..."></textarea>

                <button class="btn-primary" onclick="saveStyle()" id="saveBtn">ğŸ’¾ ìŠ¤íƒ€ì¼ ì €ì¥</button>
                <button class="btn-secondary" onclick="cancelEdit()" id="cancelBtn" style="display: none;">âœ–ï¸ ìˆ˜ì • ì·¨ì†Œ</button>

                <div id="analyzeResult"></div>
            </div>

            <!-- ì˜¤ë¥¸ìª½: ìŠ¤íƒ€ì¼ ëª©ë¡ -->
            <div class="section">
                <h2>ğŸ“‹ ì €ì¥ëœ ìŠ¤íƒ€ì¼ ëª©ë¡</h2>

                <button class="btn-secondary" onclick="loadStyles()">ğŸ”„ ëª©ë¡ ìƒˆë¡œê³ ì¹¨</button>

                <div class="styles-list" id="stylesList">
                    <p style="color: #999; text-align: center; padding: 20px;">ìŠ¤íƒ€ì¼ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
                </div>
            </div>
        </div>

        <!-- ì´ë¯¸ì§€ ë³€í™˜ í…ŒìŠ¤íŠ¸ ì„¹ì…˜ -->
        <div class="section" style="margin-top: 30px;">
            <h2>ğŸ§ª ì´ë¯¸ì§€ ë³€í™˜ í…ŒìŠ¤íŠ¸</h2>

            <div class="info">
                ğŸ’¡ ìœ„ì—ì„œ ì €ì¥í•œ ìŠ¤íƒ€ì¼ì„ ì„ íƒí•˜ê³  í…ŒìŠ¤íŠ¸ ì´ë¯¸ì§€ë¥¼ ì—…ë¡œë“œí•˜ì—¬ ë³€í™˜ ê²°ê³¼ë¥¼ í™•ì¸í•˜ì„¸ìš”.
            </div>

            <label>í…ŒìŠ¤íŠ¸í•  ìŠ¤íƒ€ì¼ ì„ íƒ *</label>
            <select id="testStyleSelect" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 16px; margin-bottom: 15px;">
                <option value="">ìŠ¤íƒ€ì¼ì„ ì„ íƒí•˜ì„¸ìš”</option>
            </select>

            <div id="selectedStyleInfo" style="display: none; background: #e0e7ff; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                <strong style="color: #667eea;">ì„ íƒëœ ìŠ¤íƒ€ì¼:</strong> <span id="selectedStyleText"></span>
            </div>

            <label>ë³€í™˜í•  ì´ë¯¸ì§€ ì—…ë¡œë“œ *</label>
            <input type="file" id="testImageInput" accept="image/*">
            <div id="testDropZone" class="drop-zone">
                <div class="drop-icon">ğŸ“·</div>
                <div class="drop-text">í…ŒìŠ¤íŠ¸ ì´ë¯¸ì§€ ì—…ë¡œë“œ</div>
                <div class="drop-hint">í´ë¦­í•˜ê±°ë‚˜ ë“œë˜ê·¸ ì•¤ ë“œë¡­</div>
            </div>

            <button class="btn-primary" onclick="testTransform()" id="testBtn" disabled>âœ¨ ì´ë¯¸ì§€ ë³€í™˜ í…ŒìŠ¤íŠ¸</button>

            <div id="testResult"></div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, collection, addDoc, getDocs, doc, getDoc, updateDoc, deleteDoc, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        import { getStorage, ref, uploadBytes, getDownloadURL, deleteObject } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js';

        // Firebase ì„¤ì •
        const firebaseConfig = {
            apiKey: "AIzaSyD-i5QR-MFeCLQtSMlIqXUhVuIzkJQBRhA",
            authDomain: "gogwan-e79bc.firebaseapp.com",
            projectId: "gogwan-e79bc",
            storageBucket: "gogwan-e79bc.firebasestorage.app",
            messagingSenderId: "241129624672",
            appId: "1:241129624672:web:920301c7f196322c761f05"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const storage = getStorage(app);

        // ì „ì—­ìœ¼ë¡œ ë…¸ì¶œ
        window.db = db;
        window.storage = storage;
        window.firestoreModules = { collection, addDoc, getDocs, doc, getDoc, updateDoc, deleteDoc, serverTimestamp };
        window.storageModules = { ref, uploadBytes, getDownloadURL, deleteObject };

        // ë“œë˜ê·¸ ì•¤ ë“œë¡­ ì„¤ì •
        function setupDropZone(dropZoneId, inputId, onFileSelected) {
            const dropZone = document.getElementById(dropZoneId);
            const fileInput = document.getElementById(inputId);

            dropZone.addEventListener('click', () => {
                fileInput.click();
            });

            fileInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    handleFile(file, dropZoneId);
                    if (onFileSelected) {
                        onFileSelected(file);
                    }
                }
            });

            dropZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropZone.classList.add('dragover');
            });

            dropZone.addEventListener('dragleave', () => {
                dropZone.classList.remove('dragover');
            });

            dropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropZone.classList.remove('dragover');
                const file = e.dataTransfer.files[0];
                if (file && file.type.startsWith('image/')) {
                    const dataTransfer = new DataTransfer();
                    dataTransfer.items.add(file);
                    fileInput.files = dataTransfer.files;
                    handleFile(file, dropZoneId);
                    if (onFileSelected) {
                        onFileSelected(file);
                    }
                }
            });
        }

        function handleFile(file, dropZoneId) {
            const reader = new FileReader();
            reader.onload = (e) => {
                const dropZone = document.getElementById(dropZoneId);
                dropZone.innerHTML = `<img src="${e.target.result}" class="preview-image">`;
                dropZone.classList.add('has-image');
            };
            reader.readAsDataURL(file);
        }

        window.fileToBase64 = function(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result.split(',')[1]);
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        };

        // ì´ë¯¸ì§€ ë¶„ì„
        window.analyzeImage = async function() {
            const resultDiv = document.getElementById('analyzeResult');
            const analysisRefDiv = document.getElementById('analysisReference');
            const analysisTextDiv = document.getElementById('analysisText');
            const imageFile = document.getElementById('referenceImageInput').files[0];

            try {
                if (!imageFile) {
                    throw new Error('ë ˆí¼ëŸ°ìŠ¤ ì´ë¯¸ì§€ë¥¼ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.');
                }

                // ë¶„ì„ ì°¸ê³  ì˜ì—­ ìˆ¨ê¸°ê¸°
                analysisRefDiv.style.display = 'none';

                resultDiv.innerHTML = `
                    <div class="loading">
                        <div class="spinner"></div>
                        <div>AIë¡œ ì´ë¯¸ì§€ ë¶„ì„ ì¤‘...</div>
                        <div style="margin-top: 10px; font-size: 0.9em; color: #999;">150ì ì´ë‚´ ì°¸ê³ ìš© ë¶„ì„ ìƒì„± ì¤‘</div>
                    </div>
                `;

                const imageBase64 = await window.fileToBase64(imageFile);

                const response = await fetch('https://gogwan-backend-818506848351.asia-northeast3.run.app/api/analyze-style-only', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ reference_image: imageBase64 })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || `API ì˜¤ë¥˜: ${response.status}`);
                }

                const data = await response.json();

                if (data.success) {
                    // ë¶„ì„ ê²°ê³¼ë¥¼ ì°¸ê³ ìš© ì˜ì—­ì— í‘œì‹œ
                    analysisTextDiv.textContent = data.style_prompt;
                    analysisRefDiv.style.display = 'block';

                    resultDiv.innerHTML = `
                        <div class="success">
                            âœ… ë¶„ì„ ì™„ë£Œ! ìœ„ ë¶„ì„ ê²°ê³¼ë¥¼ ì°¸ê³ í•˜ì—¬ ì•„ë˜ í”„ë¡¬í”„íŠ¸ë¥¼ ì§ì ‘ ì‘ì„±í•˜ì„¸ìš”.
                        </div>
                    `;
                } else {
                    throw new Error('ìŠ¤íƒ€ì¼ ë¶„ì„ ì‹¤íŒ¨');
                }

            } catch (error) {
                analysisRefDiv.style.display = 'none';
                resultDiv.innerHTML = `
                    <div class="error">
                        <strong>ì˜¤ë¥˜ ë°œìƒ:</strong><br>${error.message}
                    </div>
                `;
                console.error('Error:', error);
            }
        };

        // ìˆ˜ì • ëª¨ë“œ ì¶”ì 
        let editingDocId = null;
        let existingImageUrl = null;

        // ìŠ¤íƒ€ì¼ ìˆ˜ì •
        window.editStyle = async function(docId) {
            try {
                const { doc, getDoc } = window.firestoreModules;
                const docRef = doc(window.db, 'ai_styles', docId);
                const docSnap = await getDoc(docRef);

                if (!docSnap.exists()) {
                    alert('ìŠ¤íƒ€ì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                    return;
                }

                const style = docSnap.data();
                console.log('âœï¸ Editing style:', style.styleName);

                // ìˆ˜ì • ëª¨ë“œ í™œì„±í™”
                editingDocId = docId;
                existingImageUrl = style.imageUrl;

                // í¼ì— ë°ì´í„° ë¡œë“œ
                document.getElementById('styleId').value = style.styleId;
                document.getElementById('styleName').value = style.styleName;
                document.getElementById('styleType').value = style.styleType;
                document.getElementById('isPublic').value = style.isPublic !== undefined ? String(style.isPublic) : 'true';
                document.getElementById('stylePrompt').value = style.stylePrompt;

                // ê¸°ì¡´ ì´ë¯¸ì§€ í‘œì‹œ
                const dropZone = document.getElementById('referenceDropZone');
                dropZone.innerHTML = `<img src="${style.imageUrl}" class="preview-image">`;
                dropZone.classList.add('has-image');

                // ì €ì¥ ë²„íŠ¼ í…ìŠ¤íŠ¸ ë³€ê²½
                document.getElementById('saveBtn').textContent = 'ğŸ’¾ ìŠ¤íƒ€ì¼ ìˆ˜ì •';
                document.getElementById('cancelBtn').style.display = 'block';

                // ì•ˆë‚´ ë©”ì‹œì§€
                const resultDiv = document.getElementById('analyzeResult');
                resultDiv.innerHTML = `
                    <div class="info">
                        â„¹ï¸ '<strong>${style.styleName}</strong>' ìŠ¤íƒ€ì¼ì„ ìˆ˜ì •í•˜ê³  ìˆìŠµë‹ˆë‹¤.<br>
                        ì´ë¯¸ì§€ë¥¼ ë³€ê²½í•˜ë ¤ë©´ ìƒˆ ì´ë¯¸ì§€ë¥¼ ì—…ë¡œë“œí•˜ì„¸ìš”. (ì„ íƒì‚¬í•­)
                    </div>
                `;

                // ìŠ¤í¬ë¡¤
                window.scrollTo({ top: 0, behavior: 'smooth' });

            } catch (error) {
                console.error('âŒ Edit style error:', error);
                alert(`ì˜¤ë¥˜ ë°œìƒ: ${error.message}`);
            }
        };

        // ìˆ˜ì • ì·¨ì†Œ
        window.cancelEdit = function() {
            editingDocId = null;
            existingImageUrl = null;

            // í¼ ì´ˆê¸°í™”
            document.getElementById('styleId').value = '';
            document.getElementById('styleName').value = '';
            document.getElementById('styleType').value = '';
            document.getElementById('isPublic').value = 'true';
            document.getElementById('stylePrompt').value = '';
            document.getElementById('referenceImageInput').value = '';

            const dropZone = document.getElementById('referenceDropZone');
            dropZone.innerHTML = `
                <div class="drop-icon">ğŸ¨</div>
                <div class="drop-text">ë ˆí¼ëŸ°ìŠ¤ ì´ë¯¸ì§€ ì—…ë¡œë“œ (ì„ íƒ)</div>
                <div class="drop-hint">í´ë¦­í•˜ê±°ë‚˜ ë“œë˜ê·¸ ì•¤ ë“œë¡­</div>
            `;
            dropZone.classList.remove('has-image');

            // ë¶„ì„ ì°¸ê³  ì˜ì—­ ìˆ¨ê¸°ê¸°
            document.getElementById('analysisReference').style.display = 'none';

            document.getElementById('saveBtn').textContent = 'ğŸ’¾ ìŠ¤íƒ€ì¼ ì €ì¥';
            document.getElementById('cancelBtn').style.display = 'none';
            document.getElementById('analyzeResult').innerHTML = '';
        };

        // ìŠ¤íƒ€ì¼ ì €ì¥/ìˆ˜ì •
        window.saveStyle = async function() {
            const resultDiv = document.getElementById('analyzeResult');
            const styleId = document.getElementById('styleId').value.trim();
            const styleName = document.getElementById('styleName').value.trim();
            const styleType = document.getElementById('styleType').value;
            const isPublic = document.getElementById('isPublic').value === 'true';
            const stylePrompt = document.getElementById('stylePrompt').value.trim();
            const imageFile = document.getElementById('referenceImageInput').files[0];

            try {
                // í•„ìˆ˜ í•­ëª© ê²€ì¦ (ì´ë¯¸ì§€ëŠ” ì„ íƒì‚¬í•­)
                if (!styleId || !styleName || !styleType || !stylePrompt) {
                    throw new Error('ìŠ¤íƒ€ì¼ ID, ì´ë¦„, íƒ€ì…, í”„ë¡¬í”„íŠ¸ëŠ” í•„ìˆ˜ í•­ëª©ì…ë‹ˆë‹¤.');
                }

                console.log('ğŸ’¾ Saving style:', { styleId, styleName, styleType, isPublic, promptLength: stylePrompt.length, editMode: !!editingDocId, hasImage: !!imageFile });

                resultDiv.innerHTML = `
                    <div class="loading">
                        <div class="spinner"></div>
                        <div>ìŠ¤íƒ€ì¼ ${editingDocId ? 'ìˆ˜ì •' : 'ì €ì¥'} ì¤‘...</div>
                    </div>
                `;

                let imageUrl = existingImageUrl;

                // ìƒˆ ì´ë¯¸ì§€ê°€ ì—…ë¡œë“œëœ ê²½ìš°
                if (imageFile) {
                    console.log('ğŸ“¤ Uploading image to Storage...');
                    const storageRef = window.storageModules.ref(window.storage, `ai_styles/${styleId}`);
                    await window.storageModules.uploadBytes(storageRef, imageFile);
                    imageUrl = await window.storageModules.getDownloadURL(storageRef);
                    console.log('âœ… Image uploaded:', imageUrl);
                } else if (!editingDocId && !imageUrl) {
                    // ì‹ ê·œ ìƒì„±ì¸ë° ì´ë¯¸ì§€ê°€ ì—†ìœ¼ë©´ placeholder ì‚¬ìš©
                    console.log('â„¹ï¸ No image provided, using placeholder');
                    imageUrl = 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" width="200" height="200"%3E%3Crect fill="%23667eea" width="200" height="200"/%3E%3Ctext fill="white" font-size="20" x="50%25" y="50%25" text-anchor="middle" dominant-baseline="middle"%3EğŸ¨%3C/text%3E%3C/svg%3E';
                }

                const styleData = {
                    styleId,
                    styleName,
                    styleType,
                    isPublic,
                    stylePrompt,
                    imageUrl,
                    updatedAt: window.firestoreModules.serverTimestamp()
                };

                if (editingDocId) {
                    // ìˆ˜ì • ëª¨ë“œ
                    console.log('ğŸ“ Updating Firestore document...');
                    const { doc, updateDoc } = window.firestoreModules;
                    await updateDoc(doc(window.db, 'ai_styles', editingDocId), styleData);
                    console.log('âœ… Document updated:', editingDocId);

                    resultDiv.innerHTML = `
                        <div class="success">
                            âœ… ìŠ¤íƒ€ì¼ì´ ì„±ê³µì ìœ¼ë¡œ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤!<br>
                            <small>Document ID: ${editingDocId}</small>
                        </div>
                    `;
                } else {
                    // ìƒì„± ëª¨ë“œ
                    console.log('ğŸ“ Saving to Firestore...');
                    const { collection, addDoc } = window.firestoreModules;
                    styleData.createdAt = window.firestoreModules.serverTimestamp();
                    const docRef = await addDoc(collection(window.db, 'ai_styles'), styleData);
                    console.log('âœ… Document saved with ID:', docRef.id);

                    resultDiv.innerHTML = `
                        <div class="success">
                            âœ… ìŠ¤íƒ€ì¼ì´ ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!<br>
                            <small>Document ID: ${docRef.id}</small>
                        </div>
                    `;
                }

                // í¼ ì´ˆê¸°í™”
                cancelEdit();

                console.log('ğŸ”„ Reloading styles in 1.5 seconds...');
                setTimeout(() => {
                    loadStyles();
                    resultDiv.innerHTML = '';
                }, 1500);

            } catch (error) {
                console.error('âŒ Save style error:', error);
                resultDiv.innerHTML = `
                    <div class="error">
                        <strong>ì˜¤ë¥˜ ë°œìƒ:</strong><br>${error.message}<br>
                        <small>Console(F12)ì—ì„œ ìì„¸í•œ ì˜¤ë¥˜ë¥¼ í™•ì¸í•˜ì„¸ìš”.</small>
                    </div>
                `;
            }
        };

        // ìŠ¤íƒ€ì¼ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
        window.loadStyles = async function() {
            const listDiv = document.getElementById('stylesList');

            try {
                listDiv.innerHTML = `
                    <div class="loading">
                        <div class="spinner"></div>
                        <div>ìŠ¤íƒ€ì¼ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
                    </div>
                `;

                const { collection, getDocs } = window.firestoreModules;
                const querySnapshot = await getDocs(collection(window.db, 'ai_styles'));

                console.log('ğŸ“Š Firestore Query Result:', {
                    empty: querySnapshot.empty,
                    size: querySnapshot.size
                });

                if (querySnapshot.empty) {
                    console.log('âš ï¸ No styles found in Firestore');
                    listDiv.innerHTML = `<p style="color: #999; text-align: center; padding: 20px;">ì €ì¥ëœ ìŠ¤íƒ€ì¼ì´ ì—†ìŠµë‹ˆë‹¤.<br><small>Firebase Consoleì—ì„œ ai_styles ì»¬ë ‰ì…˜ì„ í™•ì¸í•˜ì„¸ìš”.</small></p>`;
                    return;
                }

                const styles = [];
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    console.log('ğŸ“„ Document:', doc.id, data);
                    styles.push({ id: doc.id, ...data });
                });

                console.log('âœ… Loaded styles:', styles.length);

                listDiv.innerHTML = styles.map(style => {
                    const badgeClass = style.styleType === 'face_only' ? 'badge-face-only' : 'badge-face-clothing';
                    const badgeText = style.styleType === 'face_only' ? 'ì–¼êµ´ë§Œ' : 'ì–¼êµ´+ì˜·';
                    const publicStatus = style.isPublic !== false;
                    const publicBadge = publicStatus ? '<span style="background: #10B981; color: white; padding: 2px 8px; border-radius: 4px; font-size: 11px; margin-left: 6px;">âœ… ê³µê°œ</span>' : '<span style="background: #EF4444; color: white; padding: 2px 8px; border-radius: 4px; font-size: 11px; margin-left: 6px;">ğŸ”’ ë¹„ê³µê°œ</span>';

                    return `
                        <div class="style-item">
                            <div class="style-item-header">
                                <div>
                                    <h4>ğŸ¨ ${style.styleName}
                                        <span class="style-badge ${badgeClass}">${badgeText}</span>
                                        ${publicBadge}
                                    </h4>
                                    <p>ID: ${style.styleId}</p>
                                    <p>ìƒì„±ì¼: ${style.createdAt?.toDate?.()?.toLocaleString('ko-KR') || 'N/A'}</p>
                                </div>
                                <div class="style-item-actions">
                                    <button class="btn-edit" onclick="editStyle('${style.id}')">âœï¸ ìˆ˜ì •</button>
                                    <button class="btn-delete" onclick="deleteStyle('${style.id}', '${style.styleId}')">ğŸ—‘ï¸ ì‚­ì œ</button>
                                </div>
                            </div>
                            <p style="color: #999; font-size: 0.85em; font-family: monospace; white-space: pre-wrap; max-height: 100px; overflow: hidden;">${style.stylePrompt.substring(0, 150)}...</p>
                        </div>
                    `;
                }).join('');

            } catch (error) {
                console.error('âŒ Load styles error:', error);
                listDiv.innerHTML = `
                    <div class="error">
                        ìŠ¤íƒ€ì¼ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: ${error.message}<br>
                        <small>Console(F12)ì—ì„œ ìì„¸í•œ ì˜¤ë¥˜ë¥¼ í™•ì¸í•˜ì„¸ìš”.</small>
                    </div>
                `;
            }
        };

        // ìŠ¤íƒ€ì¼ ì‚­ì œ
        window.deleteStyle = async function(docId, styleId) {
            if (!confirm(`ì •ë§ë¡œ ì´ ìŠ¤íƒ€ì¼ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                return;
            }

            try {
                const { doc, deleteDoc } = window.firestoreModules;
                const { ref, deleteObject } = window.storageModules;

                // Firestore ì‚­ì œ
                await deleteDoc(doc(window.db, 'ai_styles', docId));

                // Storage ì´ë¯¸ì§€ ì‚­ì œ
                try {
                    const storageRef = ref(window.storage, `ai_styles/${styleId}`);
                    await deleteObject(storageRef);
                } catch (e) {
                    console.log('ì´ë¯¸ì§€ ì‚­ì œ ì‹¤íŒ¨ (ì´ë¯¸ ì—†ì„ ìˆ˜ ìˆìŒ):', e);
                }

                alert('âœ… ìŠ¤íƒ€ì¼ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                loadStyles();

            } catch (error) {
                alert(`âŒ ì˜¤ë¥˜ ë°œìƒ: ${error.message}`);
                console.error('Error:', error);
            }
        };

        // ì´ë¯¸ì§€ ë³€í™˜ í…ŒìŠ¤íŠ¸
        let testImage = null;
        let selectedTestStyle = null;

        // ë²„íŠ¼ í™œì„±í™” ì²´í¬ í•¨ìˆ˜
        function checkTestButtonState() {
            const testBtn = document.getElementById('testBtn');
            if (selectedTestStyle && testImage) {
                testBtn.disabled = false;
                console.log('âœ… Test button enabled');
            } else {
                testBtn.disabled = true;
                console.log('âš ï¸ Test button disabled - style:', !!selectedTestStyle, 'image:', !!testImage);
            }
        }

        // ìŠ¤íƒ€ì¼ ì„ íƒ ì‹œ
        document.getElementById('testStyleSelect').addEventListener('change', function(e) {
            const styleData = e.target.value;
            if (styleData) {
                selectedTestStyle = JSON.parse(styleData);
                document.getElementById('selectedStyleInfo').style.display = 'block';
                document.getElementById('selectedStyleText').textContent =
                    `${selectedTestStyle.styleName} (${selectedTestStyle.styleType === 'face_only' ? 'ì–¼êµ´ë§Œ ìœ ì§€' : 'ì–¼êµ´+ì˜· ìœ ì§€'})`;
                console.log('ğŸ“‹ Style selected:', selectedTestStyle.styleName);
            } else {
                selectedTestStyle = null;
                document.getElementById('selectedStyleInfo').style.display = 'none';
            }
            checkTestButtonState();
        });

        window.testTransform = async function() {
            if (!selectedTestStyle || !testImage) {
                alert('ìŠ¤íƒ€ì¼ê³¼ ì´ë¯¸ì§€ë¥¼ ëª¨ë‘ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }

            const resultDiv = document.getElementById('testResult');
            const testBtn = document.getElementById('testBtn');

            try {
                testBtn.disabled = true;
                resultDiv.innerHTML = `
                    <div class="loading">
                        <div class="spinner"></div>
                        <div>AIë¡œ ì´ë¯¸ì§€ ë³€í™˜ ì¤‘...</div>
                        <div style="margin-top: 10px; font-size: 0.9em; color: #999;">30ì´ˆ~1ë¶„ ì •ë„ ì†Œìš”ë©ë‹ˆë‹¤</div>
                    </div>
                `;

                const imageBase64 = await window.fileToBase64(testImage);

                // ìŠ¤íƒ€ì¼ íƒ€ì…ì— ë”°ë¥¸ í”„ë¡¬í”„íŠ¸ ì¡°í•©
                let finalPrompt = selectedTestStyle.stylePrompt;
                if (selectedTestStyle.styleType === 'face_only') {
                    finalPrompt = `Analyze the person's facial features, age, gender, and ethnicity from the image. Preserve ONLY the face characteristics. Transform everything else (clothing, background, pose, accessories) according to this style: ${selectedTestStyle.stylePrompt}`;
                } else if (selectedTestStyle.styleType === 'face_and_clothing') {
                    finalPrompt = `Preserve the person's facial features AND clothing style/design from the image. Only transform the material, texture, and artistic style according to: ${selectedTestStyle.stylePrompt}`;
                }

                console.log('ğŸ§ª Testing transformation with prompt:', finalPrompt.substring(0, 100) + '...');

                const response = await fetch('https://gogwan-backend-818506848351.asia-northeast3.run.app/api/convert-with-style-prompt', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        image: imageBase64,
                        style_prompt: finalPrompt
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || `API ì˜¤ë¥˜: ${response.status}`);
                }

                const data = await response.json();

                if (data.success && data.processed_image) {
                    resultDiv.innerHTML = `
                        <div class="success" style="margin-top: 20px;">
                            âœ… ë³€í™˜ ì™„ë£Œ!
                        </div>
                        <img src="data:image/png;base64,${data.processed_image}"
                             style="max-width: 100%; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); margin-top: 15px;">
                        <p style="margin-top: 12px; text-align: center; color: #666; font-size: 0.9em;">
                            ê²°ê³¼ê°€ ë§Œì¡±ìŠ¤ëŸ¬ìš°ë©´ ì‚¬ìš©ì í˜ì´ì§€ì—ì„œë„ ë™ì¼í•˜ê²Œ ì‘ë™í•©ë‹ˆë‹¤.
                        </p>
                    `;
                    console.log('âœ… Transformation successful');
                } else {
                    throw new Error('ì´ë¯¸ì§€ ë³€í™˜ ì‹¤íŒ¨');
                }

            } catch (error) {
                console.error('âŒ Test transformation error:', error);
                resultDiv.innerHTML = `
                    <div class="error" style="margin-top: 20px;">
                        <strong>ì˜¤ë¥˜ ë°œìƒ:</strong><br>${error.message}
                    </div>
                `;
            } finally {
                testBtn.disabled = false;
            }
        };

        // ìŠ¤íƒ€ì¼ ëª©ë¡ ë¡œë“œ ì‹œ select ì˜µì…˜ë„ ì—…ë°ì´íŠ¸
        const originalLoadStyles = window.loadStyles;
        window.loadStyles = async function() {
            await originalLoadStyles();

            // Select ì˜µì…˜ ì—…ë°ì´íŠ¸
            const select = document.getElementById('testStyleSelect');
            const { collection, getDocs } = window.firestoreModules;

            try {
                const querySnapshot = await getDocs(collection(window.db, 'ai_styles'));

                select.innerHTML = '<option value="">ìŠ¤íƒ€ì¼ì„ ì„ íƒí•˜ì„¸ìš”</option>';

                querySnapshot.forEach((doc) => {
                    const style = { id: doc.id, ...doc.data() };
                    const option = document.createElement('option');
                    option.value = JSON.stringify(style);
                    option.textContent = `${style.styleName} (${style.styleType === 'face_only' ? 'ì–¼êµ´ë§Œ' : 'ì–¼êµ´+ì˜·'})`;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('Select ì˜µì…˜ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:', error);
            }
        };

        // ì´ˆê¸°í™”
        setupDropZone('referenceDropZone', 'referenceImageInput');
        setupDropZone('testDropZone', 'testImageInput', function(file) {
            testImage = file;
            console.log('ğŸ“· Test image uploaded:', file.name);
            checkTestButtonState();
        });
        loadStyles();
    </script>
</body>
</html>
