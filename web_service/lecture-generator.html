<!DOCTYPE html>
<html lang="ko">
<head>
  <script type="module" src="admin/auth-check.js"></script>
  <script src="analytics.js" type="module"></script>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AIVOCA ê°•ì˜ ìƒì„±ê¸° - Cactus Labs</title>
  <meta name="description" content="Gemini AIë¥¼ í™œìš©í•œ ì˜ì–´ ë‹¨ì–´ ê°•ì˜ ë° ìŒì„± íŒŒì¼ ìë™ ìƒì„± ë„êµ¬">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --primary: #0A0E27;
      --secondary: #6366F1;
      --accent: #8B5CF6;
      --text: #1F2937;
      --text-light: #6B7280;
      --bg: #FFFFFF;
      --bg-alt: #F9FAFB;
      --success: #10B981;
      --warning: #F59E0B;
      --error: #EF4444;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      color: var(--text);
      line-height: 1.6;
      background: var(--bg-alt);
      min-height: 100vh;
    }

    /* Navigation */
    nav {
      position: fixed;
      top: 0;
      width: 100%;
      background: rgba(255, 255, 255, 0.8);
      backdrop-filter: blur(12px);
      border-bottom: 1px solid rgba(0, 0, 0, 0.05);
      z-index: 1000;
    }

    .nav-container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 16px 32px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .logo {
      font-size: 1.25rem;
      font-weight: 700;
      color: var(--primary);
      text-decoration: none;
      letter-spacing: -0.5px;
    }

    .nav-links {
      display: flex;
      gap: 32px;
      align-items: center;
    }

    .nav-links a {
      color: var(--text);
      text-decoration: none;
      font-weight: 500;
      font-size: 0.95rem;
      transition: color 0.2s;
    }

    .nav-links a:hover {
      color: var(--secondary);
    }

    /* Main Container */
    .main-container {
      margin-top: 80px;
      padding: 40px 20px;
      max-width: 1200px;
      margin-left: auto;
      margin-right: auto;
    }

    .header {
      text-align: center;
      margin-bottom: 48px;
    }

    .header h1 {
      font-size: 2.5rem;
      font-weight: 700;
      color: var(--primary);
      margin-bottom: 12px;
      background: linear-gradient(135deg, var(--secondary) 0%, var(--accent) 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .header p {
      font-size: 1.1rem;
      color: var(--text-light);
    }

    /* Card */
    .card {
      background: white;
      border-radius: 16px;
      padding: 32px;
      margin-bottom: 24px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      transition: box-shadow 0.3s;
    }

    .card:hover {
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .card-title {
      font-size: 1.5rem;
      font-weight: 600;
      color: var(--primary);
      margin-bottom: 24px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    /* Form Controls */
    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 24px;
    }

    .form-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    label {
      font-size: 0.9rem;
      font-weight: 600;
      color: var(--text);
    }

    input[type="text"],
    input[type="number"],
    input[type="file"],
    select {
      padding: 12px 16px;
      border: 2px solid #E5E7EB;
      border-radius: 8px;
      font-size: 14px;
      transition: all 0.2s;
      font-family: inherit;
    }

    input:focus,
    select:focus {
      outline: none;
      border-color: var(--secondary);
      box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
    }

    /* Buttons */
    .btn {
      padding: 14px 28px;
      border: none;
      border-radius: 8px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .btn:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none !important;
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--secondary) 0%, var(--accent) 100%);
      color: white;
    }

    .btn-secondary {
      background: var(--bg-alt);
      color: var(--text);
    }

    .btn-success {
      background: var(--success);
      color: white;
    }

    /* File Upload Area */
    .file-upload-area {
      border: 3px dashed #D1D5DB;
      border-radius: 12px;
      padding: 48px 24px;
      text-align: center;
      background: var(--bg-alt);
      cursor: pointer;
      transition: all 0.3s;
    }

    .file-upload-area:hover {
      border-color: var(--secondary);
      background: rgba(99, 102, 241, 0.05);
    }

    .file-upload-area.dragover {
      border-color: var(--secondary);
      background: rgba(99, 102, 241, 0.1);
    }

    .file-icon {
      font-size: 64px;
      margin-bottom: 16px;
      opacity: 0.5;
    }

    .file-info {
      background: #ECFDF5;
      border-left: 4px solid var(--success);
      padding: 16px;
      border-radius: 8px;
      margin-top: 16px;
      display: none;
    }

    .file-info.show {
      display: block;
    }

    /* Progress */
    .progress-container {
      margin-top: 24px;
    }

    .status-badge {
      display: inline-block;
      padding: 6px 16px;
      border-radius: 20px;
      font-size: 13px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 16px;
    }

    .status-idle { background: #E5E7EB; color: #6B7280; }
    .status-running { background: var(--success); color: white; animation: pulse 2s infinite; }
    .status-completed { background: var(--secondary); color: white; }
    .status-error { background: var(--error); color: white; }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }

    .progress-bar-container {
      background: #E5E7EB;
      border-radius: 8px;
      height: 40px;
      overflow: hidden;
      position: relative;
      margin-bottom: 24px;
    }

    .progress-bar {
      height: 100%;
      background: linear-gradient(90deg, var(--secondary) 0%, var(--accent) 100%);
      transition: width 0.3s ease;
      position: relative;
    }

    .progress-text {
      position: absolute;
      width: 100%;
      text-align: center;
      line-height: 40px;
      font-weight: 600;
      font-size: 15px;
      color: white;
      text-shadow: 0 1px 2px rgba(0,0,0,0.3);
    }

    /* Stats Grid */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 16px;
      margin-bottom: 24px;
    }

    .stat-card {
      background: var(--bg-alt);
      padding: 20px;
      border-radius: 12px;
      text-align: center;
      border: 2px solid transparent;
      transition: all 0.2s;
    }

    .stat-card:hover {
      border-color: var(--secondary);
    }

    .stat-value {
      font-size: 32px;
      font-weight: bold;
      color: var(--secondary);
      margin-bottom: 8px;
    }

    .stat-label {
      font-size: 13px;
      color: var(--text-light);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    /* Current Word Display */
    .current-word {
      background: #FEF3C7;
      border-left: 4px solid var(--warning);
      padding: 16px;
      border-radius: 8px;
      margin-bottom: 16px;
      display: none;
    }

    .current-word.show {
      display: block;
    }

    .current-word strong {
      color: #92400E;
      font-size: 18px;
    }

    /* Log Container */
    .log-container {
      background: #1E293B;
      color: #E2E8F0;
      padding: 20px;
      border-radius: 12px;
      max-height: 300px;
      overflow-y: auto;
      font-family: 'Courier New', monospace;
      font-size: 13px;
      line-height: 1.6;
    }

    .log-entry {
      margin-bottom: 4px;
    }

    .log-success { color: #10B981; }
    .log-error { color: #EF4444; }
    .log-info { color: #3B82F6; }

    /* Alert Box */
    .alert {
      padding: 16px;
      border-radius: 8px;
      margin-bottom: 20px;
      border-left: 4px solid;
    }

    .alert-info {
      background: #EFF6FF;
      border-color: #3B82F6;
      color: #1E40AF;
    }

    .alert-warning {
      background: #FEF3C7;
      border-color: var(--warning);
      color: #92400E;
    }

    /* Download Section */
    .download-section {
      text-align: center;
      padding: 32px;
      background: linear-gradient(135deg, var(--secondary) 0%, var(--accent) 100%);
      border-radius: 12px;
      color: white;
      display: none;
    }

    .download-section.show {
      display: block;
    }

    .download-section h3 {
      font-size: 1.5rem;
      margin-bottom: 16px;
    }

    .download-btn {
      background: white;
      color: var(--secondary);
      padding: 16px 32px;
      font-size: 16px;
      font-weight: 700;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .download-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
    }

    /* Responsive */
    @media (max-width: 768px) {
      .header h1 {
        font-size: 1.8rem;
      }

      .form-grid {
        grid-template-columns: 1fr;
      }

      .stats-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }
  </style>
</head>
<body>
  <!-- Navigation -->
  <nav>
    <div class="nav-container">
      <a href="index.html" class="logo">Cactus Labs</a>
      <div class="nav-links">
        <a href="index.html">í™ˆ</a>
        <a href="admin/index.html">ê´€ë¦¬ì</a>
        <a href="lecture-generator.html">ê°•ì˜ ìƒì„±ê¸°</a>
        <button onclick="adminLogout()" style="background: #ef4444; border: none; color: white; padding: 8px 20px; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.3s; font-size: 0.95rem;">ğŸšª ë¡œê·¸ì•„ì›ƒ</button>
      </div>
    </div>
  </nav>

  <!-- Main Container -->
  <div class="main-container">
    <!-- Header -->
    <div class="header">
      <h1>ğŸ“ AIVOCA ê°•ì˜ ìƒì„±ê¸°</h1>
      <p>Gemini AIë¥¼ í™œìš©í•œ ì˜ì–´ ë‹¨ì–´ ê°•ì˜ ë° ìŒì„± íŒŒì¼ ìë™ ìƒì„±</p>
    </div>

    <!-- Settings Card -->
    <div class="card">
      <h2 class="card-title">âš™ï¸ ì„¤ì •</h2>

      <div class="form-grid">
        <div class="form-group">
          <label for="apiKey">Gemini API í‚¤</label>
          <input type="text" id="apiKey" placeholder="AIzaSy..." value="AIzaSyBNf-EYsg6R70Qtsw_mAZpjkOEwpS0EyR8">
        </div>

        <div class="form-group">
          <label for="startIndex">ì‹œì‘ ì¸ë±ìŠ¤</label>
          <input type="number" id="startIndex" value="0" min="0">
        </div>

        <div class="form-group">
          <label for="endIndex">ì¢…ë£Œ ì¸ë±ìŠ¤ (ì„ íƒ)</label>
          <input type="number" id="endIndex" placeholder="ë¹„ì›Œë‘ë©´ ëê¹Œì§€">
        </div>
      </div>

      <!-- CSV Upload Area -->
      <div class="form-group">
        <label>CSV íŒŒì¼ ì„ íƒ</label>
        <div id="csvDropZone" class="file-upload-area">
          <div class="file-icon">ğŸ“„</div>
          <div style="font-size: 16px; margin-bottom: 8px; font-weight: 600;">CSV íŒŒì¼ì„ ë“œë˜ê·¸í•˜ê±°ë‚˜ í´ë¦­í•˜ì„¸ìš”</div>
          <div style="font-size: 14px; color: var(--text-light);">ì˜ì–´, í•œê¸€, í’ˆì‚¬ ì •ë³´ê°€ í¬í•¨ëœ CSV íŒŒì¼</div>
        </div>
        <input type="file" id="csvFile" accept=".csv" style="display: none;">

        <div id="fileInfo" class="file-info">
          <div style="font-weight: 600; margin-bottom: 8px;">âœ… íŒŒì¼ ë¡œë“œ ì™„ë£Œ</div>
          <div style="font-size: 14px;" id="fileInfoText"></div>
        </div>
      </div>

      <div class="alert alert-info">
        <strong>ğŸ’¡ ì‚¬ìš© ë°©ë²•:</strong> CSV íŒŒì¼ì„ ì„ íƒí•˜ê³  ì‹œì‘ ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”. ìƒì„±ëœ íŒŒì¼ì€ ìë™ìœ¼ë¡œ ë‹¤ìš´ë¡œë“œë©ë‹ˆë‹¤.
      </div>

      <button class="btn btn-primary" id="startBtn" onclick="startGeneration()" style="width: 100%;">
        ğŸš€ ìƒì„± ì‹œì‘
      </button>
    </div>

    <!-- Progress Card -->
    <div class="card" id="progressCard" style="display: none;">
      <h2 class="card-title">ğŸ“Š ì§„í–‰ ìƒí™©</h2>

      <div class="progress-container">
        <span id="statusBadge" class="status-badge status-idle">ëŒ€ê¸°ì¤‘</span>
        <div style="margin-bottom: 16px; color: var(--text-light);" id="statusText">ì¤€ë¹„</div>

        <div class="progress-bar-container">
          <div class="progress-bar" id="progressBar" style="width: 0%"></div>
          <div class="progress-text" id="progressText">0%</div>
        </div>

        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-value" id="currentStat">0</div>
            <div class="stat-label">ì²˜ë¦¬</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="totalStat">0</div>
            <div class="stat-label">ì „ì²´</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="errorStat">0</div>
            <div class="stat-label">ì˜¤ë¥˜</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="etaStat">-</div>
            <div class="stat-label">ë‚¨ì€ ì‹œê°„</div>
          </div>
        </div>

        <div id="currentWordDiv" class="current-word">
          ì²˜ë¦¬ ì¤‘: <strong id="currentWord"></strong>
        </div>
      </div>
    </div>

    <!-- Log Card -->
    <div class="card" id="logCard" style="display: none;">
      <h2 class="card-title">ğŸ“ ë¡œê·¸</h2>
      <div class="log-container" id="logContainer"></div>
    </div>

    <!-- Download Section -->
    <div class="download-section" id="downloadSection">
      <h3>âœ… ìƒì„± ì™„ë£Œ!</h3>
      <p style="margin-bottom: 24px;">ëª¨ë“  ê°•ì˜ì™€ ìŒì„± íŒŒì¼ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.</p>
      <button class="download-btn" onclick="downloadAllFiles()">ğŸ“¦ ëª¨ë“  íŒŒì¼ ë‹¤ìš´ë¡œë“œ (ZIP)</button>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script>
    let words = [];
    let generatedFiles = {
      lectures: {},
      audio: {}
    };
    let progress = {
      status: 'idle',
      total: 0,
      current: 0,
      errors: 0,
      startTime: null
    };

    // CSV íŒŒì¼ ë“œë˜ê·¸ ì•¤ ë“œë¡­
    const csvDropZone = document.getElementById('csvDropZone');
    const csvFileInput = document.getElementById('csvFile');

    csvDropZone.addEventListener('click', () => {
      csvFileInput.click();
    });

    csvDropZone.addEventListener('dragover', (e) => {
      e.preventDefault();
      csvDropZone.classList.add('dragover');
    });

    csvDropZone.addEventListener('dragleave', () => {
      csvDropZone.classList.remove('dragover');
    });

    csvDropZone.addEventListener('drop', (e) => {
      e.preventDefault();
      csvDropZone.classList.remove('dragover');
      const file = e.dataTransfer.files[0];
      if (file && file.name.endsWith('.csv')) {
        handleCsvFile(file);
      } else {
        alert('CSV íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”.');
      }
    });

    csvFileInput.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (file) {
        handleCsvFile(file);
      }
    });

    // CSV íŒŒì¼ ì²˜ë¦¬
    async function handleCsvFile(file) {
      const text = await file.text();
      words = parseCSV(text);

      const fileInfo = document.getElementById('fileInfo');
      const fileInfoText = document.getElementById('fileInfoText');

      fileInfo.classList.add('show');
      fileInfoText.innerHTML = `<strong>íŒŒì¼ëª…:</strong> ${file.name}<br><strong>ë‹¨ì–´ ê°œìˆ˜:</strong> ${words.length}ê°œ`;
    }

    // CSV íŒŒì‹±
    function parseCSV(text) {
      const lines = text.trim().split('\n');
      return lines.map(line => {
        const parts = line.split(',');
        return {
          english: parts[0]?.trim(),
          korean: parts[1]?.trim(),
          partOfSpeech: parts[2]?.trim() || ''
        };
      }).filter(w => w.english);
    }

    // ë¡œê·¸ ì¶”ê°€
    function addLog(message, type = 'info') {
      const logContainer = document.getElementById('logContainer');
      const logCard = document.getElementById('logCard');
      logCard.style.display = 'block';

      const entry = document.createElement('div');
      entry.className = `log-entry log-${type}`;
      entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
      logContainer.appendChild(entry);
      logContainer.scrollTop = logContainer.scrollHeight;
    }

    // UI ì—…ë°ì´íŠ¸
    function updateUI() {
      const { status, total, current, errors } = progress;

      document.getElementById('statusBadge').className = `status-badge status-${status}`;
      document.getElementById('statusText').textContent = `${current} / ${total}`;

      const percentage = total > 0 ? Math.round((current / total) * 100) : 0;
      document.getElementById('progressBar').style.width = percentage + '%';
      document.getElementById('progressText').textContent = percentage + '%';

      document.getElementById('currentStat').textContent = current;
      document.getElementById('totalStat').textContent = total;
      document.getElementById('errorStat').textContent = errors;

      // ì˜ˆìƒ ì‹œê°„
      if (status === 'running' && current > 0) {
        const elapsed = Date.now() - progress.startTime;
        const avgTime = elapsed / current;
        const remaining = (total - current) * avgTime;
        document.getElementById('etaStat').textContent = formatTime(remaining);
      }
    }

    function formatTime(ms) {
      const seconds = Math.floor(ms / 1000);
      const minutes = Math.floor(seconds / 60);
      if (minutes > 0) {
        return `${minutes}ë¶„ ${seconds % 60}ì´ˆ`;
      }
      return `${seconds}ì´ˆ`;
    }

    // Geminië¡œ ê°•ì˜ ìƒì„±
    async function generateLecture(word, apiKey) {
      const prompt = `
ê³ ë“±í•™ìƒì„ ìœ„í•œ ì˜ì–´ ê°•ì˜ì…ë‹ˆë‹¤. ë‹´ë°±í•˜ê³  í¥ë¯¸ë¡­ê²Œ ìˆ˜ì—…í•˜ë“¯ì´ ë‹¨ì–´ë¥¼ ì„¤ëª…í•˜ì„¸ìš”.

ë‹¨ì–´: ${word.english}

**ìŠ¤íƒ€ì¼:**
- ë°˜ë“œì‹œ ê²½ì–´ì²´("-ìŠµë‹ˆë‹¤", "-ã…‚ë‹ˆë‹¤") ì‚¬ìš©
- ëª©ì°¨ë‚˜ ë²ˆí˜¸ ì—†ì´ ìì—°ìŠ¤ëŸ½ê²Œ ì„¤ëª…
- ë‹´ë°±í•˜ê²Œ ì‚¬ì‹¤ì„ ì „ë‹¬í•˜ë˜ í¥ë¯¸ë¡­ê²Œ
- ê³ ë“±í•™ìƒ ìˆ˜ì¤€ì˜ ì´í•´í•˜ê¸° ì‰¬ìš´ ì˜ˆë¬¸ 2ê°œ í¬í•¨
- ë°˜ë“œì‹œ 600ì ì´ë‚´!

**í•„ìˆ˜ í¬í•¨ ë‚´ìš©:**
- í•œê¸€ ëœ»
- ë°œìŒ (í•œê¸€ë¡œ)
- ì–´ì› (ê°„ë‹¨íˆ)
- ë™ì˜ì–´/ìœ ì˜ì–´ (ë¹„ìŠ·í•œ ë‹¨ì–´ë“¤)
- ë°˜ì˜ì–´ (ë°˜ëŒ€ ì˜ë¯¸ ë‹¨ì–´)
- ì˜ˆë¬¸ 2ê°œ (í•œê¸€ ë²ˆì—­ í¬í•¨)
- ì•”ê¸° íŒ
`;

      const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-exp:generateContent?key=${apiKey}`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          contents: [{
            parts: [{ text: prompt }]
          }]
        })
      });

      if (!response.ok) {
        throw new Error(`API ì˜¤ë¥˜: ${response.status}`);
      }

      const data = await response.json();
      return data.candidates[0].content.parts[0].text;
    }

    // Gemini TTSë¡œ ìŒì„± ìƒì„±
    async function generateAudio(text, apiKey) {
      const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-exp:generateContent?key=${apiKey}`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          contents: [{
            parts: [{ text: text }]
          }],
          generationConfig: {
            responseModalities: ['AUDIO'],
            speechConfig: {
              voiceConfig: {
                prebuiltVoiceConfig: {
                  voiceName: 'Kore'
                }
              }
            }
          }
        })
      });

      if (!response.ok) {
        throw new Error(`TTS API ì˜¤ë¥˜: ${response.status}`);
      }

      const data = await response.json();
      const audioData = data.candidates[0].content.parts[0].inlineData.data;

      // base64ë¥¼ Blobìœ¼ë¡œ ë³€í™˜
      const binaryString = atob(audioData);
      const bytes = new Uint8Array(binaryString.length);
      for (let i = 0; i < binaryString.length; i++) {
        bytes[i] = binaryString.charCodeAt(i);
      }

      // PCMì„ WAVë¡œ ë³€í™˜
      return convertPcmToWav(bytes);
    }

    // PCMì„ WAVë¡œ ë³€í™˜
    function convertPcmToWav(pcmData) {
      const sampleRate = 24000;
      const numChannels = 1;
      const bitsPerSample = 16;

      const byteRate = sampleRate * numChannels * bitsPerSample / 8;
      const blockAlign = numChannels * bitsPerSample / 8;
      const dataSize = pcmData.length;

      const header = new ArrayBuffer(44);
      const view = new DataView(header);

      // RIFF header
      writeString(view, 0, 'RIFF');
      view.setUint32(4, 36 + dataSize, true);
      writeString(view, 8, 'WAVE');

      // fmt sub-chunk
      writeString(view, 12, 'fmt ');
      view.setUint32(16, 16, true);
      view.setUint16(20, 1, true);
      view.setUint16(22, numChannels, true);
      view.setUint32(24, sampleRate, true);
      view.setUint32(28, byteRate, true);
      view.setUint16(32, blockAlign, true);
      view.setUint16(34, bitsPerSample, true);

      // data sub-chunk
      writeString(view, 36, 'data');
      view.setUint32(40, dataSize, true);

      // Combine header and data
      const wavData = new Uint8Array(44 + dataSize);
      wavData.set(new Uint8Array(header), 0);
      wavData.set(pcmData, 44);

      return new Blob([wavData], { type: 'audio/wav' });
    }

    function writeString(view, offset, string) {
      for (let i = 0; i < string.length; i++) {
        view.setUint8(offset + i, string.charCodeAt(i));
      }
    }

    // ë‹¨ì–´ ì²˜ë¦¬
    async function processWord(word, apiKey) {
      const currentWordDiv = document.getElementById('currentWordDiv');
      currentWordDiv.classList.add('show');
      document.getElementById('currentWord').textContent = word.english;

      try {
        addLog(`ì²˜ë¦¬ ì‹œì‘: ${word.english}`, 'info');

        // ê°•ì˜ ìƒì„±
        const lecture = await generateLecture(word, apiKey);

        const lectureData = {
          word: word.english,
          korean: word.korean,
          partOfSpeech: word.partOfSpeech,
          lecture: lecture,
          generatedAt: new Date().toISOString()
        };

        generatedFiles.lectures[word.english] = JSON.stringify(lectureData, null, 2);

        // ìŒì„± ìƒì„±
        const audioBlob = await generateAudio(lecture, apiKey);
        generatedFiles.audio[word.english] = audioBlob;

        addLog(`âœ… ì™„ë£Œ: ${word.english}`, 'success');
        return { success: true };
      } catch (error) {
        addLog(`âŒ ì‹¤íŒ¨: ${word.english} - ${error.message}`, 'error');
        progress.errors++;
        return { success: false, error: error.message };
      }
    }

    // ìƒì„± ì‹œì‘
    async function startGeneration() {
      const apiKey = document.getElementById('apiKey').value.trim();
      const startIndex = parseInt(document.getElementById('startIndex').value) || 0;
      const endIndex = parseInt(document.getElementById('endIndex').value) || words.length;

      if (!apiKey) {
        alert('API í‚¤ë¥¼ ì…ë ¥í•˜ì„¸ìš”');
        return;
      }

      if (words.length === 0) {
        alert('CSV íŒŒì¼ì„ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”');
        return;
      }

      const targetWords = words.slice(startIndex, endIndex);

      progress = {
        status: 'running',
        total: targetWords.length,
        current: 0,
        errors: 0,
        startTime: Date.now()
      };

      generatedFiles = { lectures: {}, audio: {} };

      document.getElementById('progressCard').style.display = 'block';
      document.getElementById('startBtn').disabled = true;

      addLog(`ìƒì„± ì‹œì‘: ${targetWords.length}ê°œ ë‹¨ì–´`, 'info');

      for (let i = 0; i < targetWords.length; i++) {
        await processWord(targetWords[i], apiKey);
        progress.current = i + 1;
        updateUI();

        // Rate limit ë°©ì§€ (1ì´ˆ ëŒ€ê¸°)
        await new Promise(resolve => setTimeout(resolve, 1000));
      }

      progress.status = 'completed';
      updateUI();

      document.getElementById('currentWordDiv').classList.remove('show');
      document.getElementById('downloadSection').classList.add('show');
      document.getElementById('startBtn').disabled = false;

      addLog('âœ… ëª¨ë“  ì²˜ë¦¬ ì™„ë£Œ!', 'success');
    }

    // ëª¨ë“  íŒŒì¼ ë‹¤ìš´ë¡œë“œ
    async function downloadAllFiles() {
      const zip = new JSZip();

      // ê°•ì˜ JSON ì¶”ê°€
      const lecturesFolder = zip.folder('lectures');
      Object.entries(generatedFiles.lectures).forEach(([word, content]) => {
        lecturesFolder.file(`${word}.json`, content);
      });

      // ìŒì„± íŒŒì¼ ì¶”ê°€
      const audioFolder = zip.folder('audio');
      Object.entries(generatedFiles.audio).forEach(([word, blob]) => {
        audioFolder.file(`${word}.wav`, blob);
      });

      // ZIP ìƒì„± ë° ë‹¤ìš´ë¡œë“œ
      addLog('ZIP íŒŒì¼ ìƒì„± ì¤‘...', 'info');
      const zipBlob = await zip.generateAsync({ type: 'blob' });

      const url = URL.createObjectURL(zipBlob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `aivoca-lectures-${Date.now()}.zip`;
      a.click();
      URL.revokeObjectURL(url);

      addLog('âœ… ë‹¤ìš´ë¡œë“œ ì™„ë£Œ!', 'success');
    }
  </script>
</body>
</html>
